{% extends "templates/web.html" %}

{% block page_content %}

<div id="license_check"></div>

<button id="opencamera">Open Camera</button>
<div id="reader" width="600px"></div>

<div class="print-preview" style="max-width: 8.3in;">
    <iframe id="frame" class="print-format-container" width="100%" height="0" frameborder="0" scrolling="no"
        style="height: 1122.23px;">
    </iframe>

</div>


{% endblock %}

{% block script %}

{{ include_script('licensecheck.bundle.js') }}

{#
<script>

    async function loadIframe(result) {
        let iframe = document.getElementById("frame")
        
        let doc = await frappe.get_doc("License",result.name)
        let content = await frappe.call("maechan.api.license_preivew",result)
        var frameDoc = iframe.document;
        if (iframe.contentWindow)
            frameDoc = iframe.contentWindow.document; // IE
        // Write into iframe
        frameDoc.open();
        frameDoc.writeln(content.message);
        frameDoc.close();
    }

    function startScan() {
        const html5QrCode = new Html5Qrcode(/* element id */ "reader");

        Html5Qrcode.getCameras().then(devices => {
            console.log(devices)
            if (devices && devices.length) {
                var cameraId = devices[0].id;
                // .. use this to start scanning.
                html5QrCode.start(
                    cameraId,
                    {
                        fps: 10,    // Optional, frame per seconds for qr code scanning
                        qrbox: { width: 250, height: 250 }  // Optional, if you want bounded box UI
                    },
                    (decodedText, decodedResult) => {
                        // do something when code is read
                        try {
                            result = JSON.parse(decodedResult.decodedText)
                            loadIframe(result)
                            html5QrCode.stop()

                        } catch (e) {
                            console.log('error', e)
                        }

                    },
                    (errorMessage) => {
                        // parse error, ignore it.
                    })
                    .catch((err) => {
                        // Start failed, handle it.
                    });
            }
        })
    }

    let opencamera = document.getElementById("opencamera");
    opencamera.onclick = startScan;

</script>

#}
{% endblock %}